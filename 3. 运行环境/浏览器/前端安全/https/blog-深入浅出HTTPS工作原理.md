# [深入浅出HTTPS工作原理](https://blog.csdn.net/wangtaomtk/article/details/80917081)

## http的三大风险：

* 被窃听的风险，第三方可以截获并查看你的内容；
* 被篡改的风险，第三方可以截获并修改你的内容;
* 被冒充的风险，第三方可以伪装成通信方和你通信；

## https概念：

SSL/TLS、数字证书、数字签名、加密、认证、公钥私钥

## 非对称加密算法（RSA）

内容加密的一种算法，它有两个密钥，公钥和私钥。公钥是公开的，私钥只有持有者知道。通过公钥加密内容，只能通过私钥解密。**私密性较高，但是消耗性能**；

公钥加密的内容，只有私钥可以解，私钥加密的内容，所有公钥都可以解；

## 一个小故事

Bob与好朋友通讯，Bob弄到了两把钥匙：公钥和私钥；

Bob把公钥发给了三个好朋友：Pat、Doug和Susan，自己保留了私钥；

朋友要跟Bob进行通信就可以先用公钥加密了通信内容，然后发送给Bob，Bob再用私钥解密内容；

Bob看完信后，决定给朋友回一封信，为了防止信的内容被篡改（或者别人冒充他的身份和朋友通讯），他用hash算法对信的内容做一次处理，得到一个字符串hash值，又用自己的私钥对哈希值做了一次加密，得到一个签名，然后把**明文的信**和签名一起发送给朋友；

**注：这里Bob不担心内容被窥视，他需要保证的是和朋友通讯的为他本人，并且保证通信的内容的完整性；**

朋友收到了Bob的回信之后，先用公钥对签名作解密，得到哈希值A，然后用同样的哈希算法对信的内容作了一次哈希处理，得到另一个哈希值B，对比A和B，如果两个值相同，则可以确定信就是Bob本人写的，并且内容没有被篡改；

**注：上面的签名，就是数字签名**

数字签名简述：发送方通过**不可逆算法**对内容进行处理（哈希），得到哈希值，通过密钥加密哈希值得到签名，对方接收内容和签名，用公钥解密签名得到哈希值，对内容进行同样的处理（哈希），得到另一个哈希值，比对两个哈希值是否一致；

## 小故事中更复杂的情况出现了

Bob通过网络把公钥和私钥给朋友的，一个不怀好意的家伙Jerry截获了Bob给朋友Doug的公钥，并且把自己的公钥给了Doug，伪装成Bob跟Doug通信，Doug无法确认通信对象是不是Bob;

Bob最终发现自己的公钥被Jerry截获了，为此他发现通过网络传输公钥也不是安全的方式。为此，他想到了去第三方权威机构“证书中心”(certificate authority，简称CA)做认证；

证书中心用自己的私钥对Bob的公钥和其他信息做了一次加密，生成证书，Bob通过网络将数字证书传递给小朋友后，他的朋友先用CA给的公钥对证书进行解密，这样可以安全获取Bob的公钥；

## https协议的通信过程

1. 浏览器向服务器的443端口发起请求，请求附带浏览器支持的加密算法和哈希算法；
2. 服务器收到请求，选择浏览器支持的加密和哈希算法；
3. 服务器将数字证书返回给浏览器，数字证书可以是某个可靠机构申请的，也可以是自制的；
4. 浏览器进入数字证书认证环节，这部分是浏览器内置的TLS完成的；
5. 浏览器会先从内置的证书列表中索引，找到服务器下发证书对应的机构，如果没有找到，则会提示用户该证书不是由权威机构颁发，是不可信任的；如果找到，则取出该机构的公钥；
6. 用机构的公钥解密得到证书的内容和证书签名，内容包括网站的网址、网站的公钥、证书的有效期等，浏览器会先验证证书签名的合法性（类似上述朋友通信的验证），签名通过后，浏览器验证证书记录的网址和当前网址是否一致，不一致会提示用户；如果网址一致会校验有效期，过期了也会提示用户，这些都通过认证后，浏览器可以安全使用网站公钥；
7. 浏览器生成一个随机数R，并使用网站的公钥对R进行加密；
8. 浏览器将加密的R传给服务器；
9. 服务器用自己的私钥解密得到R；
10. 服务器以R为密钥使用了**对称加密算法**加密网页内容并传输给浏览器；
11. 浏览器以R为密钥使用之前约定好的解密算法获取网页内容；

前5步就是https的握手过程，主要是认证服务端证书的合法性，因为非对称加密消耗比较大，整个通信过程中只会进行一次非对称加密算法（也就是传输随机数R），后续利用R为密钥进行对称加密算法；

SSL/TSL是https的核心模块，TSL的前身是SSL，TSL1.0就是SSL3.1，SSL/TSL协议建立在TCP协议之上，因此同样是应用层协议；

## 对称加密和非对称加密

对称加密中，加密解密用的同一个密钥，加密方法有AES、DES、RC4、BlowFish等；非对称加密中，加密解密用的不同密钥，分别称为公钥和私钥，加密方法有RSA、DSA等；

## 证书

对于任意个体来说，都有公钥、私钥和证书；其中私钥用来加密发送出去的消息，公钥用来解密收到的消息，证书用来证明自己的身份；

证书中一般包含自己的公钥和额外信息，如签发机构，证书用途和有效时间等；

申请一个证书的通常流程是：

* 用私钥生成证书签名请求；
* 将csr文件发送给CA，待其验证信息无误后，CA会用自己的私钥对其进行签名确认；
