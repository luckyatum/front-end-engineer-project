# [CSRF攻击与防御（写得非常好）](https://blog.csdn.net/xiaoxinshuaiga/article/details/80766369)

1. CSRF是什么？

    攻击者盗用你的身份，并且向服务器发送请求，对于服务器来说这个请求是合法的，但是却完成了攻击者的一个操作；例如发邮件、盗取账号、转账、买卖商品、添加管理员账号等等；

2. CSRF过程解析？

    * Web A为存在CSRF漏洞的网站，Web B是攻击者构建的网站，C是用户；
    * C打开浏览器访问A网站，输入用户名密码登陆A网站；
    * A网站将cookie信息返回到浏览器，此时用户登录A网站成功，可以正常发送请求到A网站；
    * C在同一个浏览器，又打开了一个TAB页访问B站；
    * B站在接收到用户请求后，返回一些攻击性的代码，并发出一个请求要访问站点A；
    * 浏览器会带上原先存在cookie的信息，向A站发一个请求；
    * A站并不知道请求是来自B发起的，而是会根据cookie中的信息，用C的权限来处理；

3. CSRF典型例子？

    受害者Bob在银行有一笔存款；

    通过对银行网站发送：http://bank.example/withdraw?account=bob&amount=1000000&for=bob2可以把bob的1000000转给bob2；

    黑客Mallory在该银行也有自己的账户，因此他制作了一个网站，网站中放入如下代码：src="http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory"；

    然后利用广告诱惑Bob点击进入自己的网站，只要Bob进入网站，该网站就会从Bob的浏览器发送请求到银行；

    而这个请求会附带Bob浏览器中保存下来的cookie，如果刚好此时Bob留在服务器的session尚未过期，就会导致该条请求成功，Bob的钱就会转给Mallory；

4. CSRF防御？

    * 验证HTTP Referer字段

        根据HTTP协议，在http header中有一个Referer字段，记录了请求来源地址；通常情况下，服务器要接收一个请求，只接收来自白名单配置中的域名请求，而黑客通过构造网站所发起的请求，来源就会是黑客的网站域名，所以验证referer，能一定程度上减少CSRF的风险；

        优点：简单易行，而且研发不需要做过多的工作，只要最后把请求交给一个统一的http referer校验服务就好；
        缺点：referer是浏览器产生的，不能保证浏览器没有安全漏洞，因此百分百的把自己网站的安全交给第三方浏览器负责，是不明智的。
        缺点：同时，有些用户会觉得把referer信息设置在请求中，会导致自己的隐私泄漏，因此很多时候请求方是不会带上referer字段的；

    * 请求地址中添加token并验证

        CSRF之所以能成功，就是因为服务端只验证了cookie中的信息，所以如果在请求参数中要求带上一个随机token，并且一旦该token验证不通过就拒绝该请求，那么就可以减少CSRF漏洞风险；

        优点：这种方式比referer字段要更安全；
        缺点：请求数量过多时，客户端某些请求容易遗漏携带token；同时对于post表单请求，如果是页面上动态生成的html，则还需要程序员手动添加token，比较麻烦；
        缺点：难以保证token不被黑客得到，例如黑客可以在论坛类网站带上自己的网站域名，由于请求都是会带上token的，这样黑客可以在自己的网站上得到该token；

    * 在header中自定义属性并验证

        这种方式和token类似，但是不是将验证信息携带在参数中，而是将其放入http的header中，这样可以解决第二个方法中添加token的不便，同时该token值不会记录在浏览器地址栏，因此不用担心token值会通过referer泄漏出去；

        缺点：局限性大，只能是ajax请求可以添加；也就是说对于历史遗留下来的系统，要解决这种问题需要把请求全部改成ajax请求，工程量大；
